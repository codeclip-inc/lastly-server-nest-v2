name: CI/CD

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - develop
      - 'release/*'
  pull_request:
    types: [closed]
    branches:
      - 'release/*'

permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false


jobs:
  ci:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action == 'closed')
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install & Build & Test
        run: |
          yarn install --frozen-lockfile
          yarn build
          yarn test --ci
  deploy-staging:
    runs-on: ubuntu-latest
    needs: ci
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.base.ref, 'release/') &&
      github.event.pull_request.head.ref == 'develop'
    environment: staging
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Show PR context (debug)
        run: |
          echo "PR base: ${{ github.event.pull_request.base.ref }}"
          echo "PR head: ${{ github.event.pull_request.head.ref }}"
          echo "Merged:  ${{ github.event.pull_request.merged }}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build & Push Staging Image
        env:
          REL: ${{ github.event.pull_request.base.ref }}
        run: |
          REL_VER="${REL#release/}"

          echo "Release version  : ${REL_VER}"
          echo "Docker image tag : release-${REL_VER}"

          docker buildx build --platform linux/amd64 \
            -t junmay6/lastly:release-${REL_VER} \
            --push .
          echo "REL_VER=${REL_VER}" >> $GITHUB_ENV

      - name: Deploy to Staging EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            docker stop lastly-staging || true
            docker rm lastly-staging || true
            docker rmi junmay6/lastly:release-${{ env.REL_VER }} || true

            docker pull junmay6/lastly:release-${{ env.REL_VER }}
            docker run -d --name lastly-staging \
              --env-file /opt/app/.env \
              -p 3000:3000 \
              junmay6/lastly:release-${{ env.REL_VER }}

  deploy-production:
    runs-on: ubuntu-latest
    needs: ci
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/')
    environment: production
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Ensure tag commit is on main
        run: |
          git fetch origin main
          TAG_COMMIT="$(git rev-parse '${{ github.ref }}')"
          if git merge-base --is-ancestor "$TAG_COMMIT" origin/main; then
            echo "Tag commit is on main."
          else
            echo "Tag commit is NOT on main. Abort."
            exit 1
          fi
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & Push Prod Image
        run: |
          VER="${GITHUB_REF_NAME#v}"
          PROD_TAG="l${VER}"

          echo "Git tag          : ${GITHUB_REF_NAME}"
          echo "Docker image tag : ${PROD_TAG}"

          docker buildx build --platform linux/amd64 \
            -t junmay6/lastly:${PROD_TAG} \
            --push .
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
    
      - name: Update IMAGE_TAG in SSM
        run: |
          VER="${GITHUB_REF_NAME#v}"
          PROD_TAG="l${VER}"

          aws ssm put-parameter \
            --name /lastly/prod/IMAGE_TAG \
            --value "${PROD_TAG}" \
            --type String \
            --overwrite \
            --region ap-northeast-2

      - name: Trigger ASG Rolling Update
        run: |
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name lastly-asg \
            --preferences '{"MinHealthyPercentage": 50, "InstanceWarmup": 60}' \
            --region ap-northeast-2